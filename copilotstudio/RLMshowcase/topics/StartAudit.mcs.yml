# Name: Start Audit
kind: AdaptiveDialog
beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent:
    displayName: Start Audit
    triggerQueries:
      - start audit
      - begin audit
      - initiate audit process
      - launch an audit
      - kick off audit
      - run an audit now

  actions:
    - kind: Question
      id: question_oaXyT8
      interruptionPolicy:
        allowInterruption: true

      variable: init:Topic.Query
      prompt: What should I audit for?
      entity:
        kind: EmbeddedEntity
        definition:
          kind: ClosedListEntity
          items:
            - id: Audit these invoices against the travel policy
              displayName: Audit these invoices against the travel policy

            - id: Run code audit through the repository
              displayName: Run code audit through the repository

    - kind: ConditionGroup
      id: conditionGroup_te3bUS
      conditions:
        - id: conditionItem_0KvBoU
          condition: =Topic.Query = 'copilots_header_54b8d.topic.StartAudit.main.question_oaXyT8'.'Audit these invoices against the travel policy'

        - id: conditionItem_2O5y3N
          condition: =Topic.Query = 'copilots_header_54b8d.topic.StartAudit.main.question_oaXyT8'.'Run code audit through the repository'

    - kind: BeginDialog
      id: Action_StartJob
      input:
        binding:
          query: =Text(Topic.Query)

      dialog: copilots_header_54b8d.action.StartAuditJob
      output:
        binding:
          job_id: Topic.job_id
          message: Topic.message
          status: Topic.status

    - kind: SendActivity
      id: SendActivity_StartMsg
      activity: "Audit Started! Job ID: {Topic.job_id}"

    - kind: BeginDialog
      id: Action_GetStatus
      input:
        binding:
          job_id:

      dialog: copilots_header_54b8d.action.GetAuditStatus
      output:
        binding:
          created_at: Topic.created_at
          job_id: Topic.job_id
          logs: Topic.logs
          logs_text: Topic.logs_text
          message: Topic.message
          progress_percent: Topic.progress_percent
          result: Topic.result
          status: Topic.status
          updated_at: Topic.updated_at

    - kind: ConditionGroup
      id: Condition_CheckStatus
      conditions:
        - id: Condition_Success
          condition: =Topic.status = "completed"
          actions:
            - kind: SendActivity
              id: SendActivity_Success
              activity: Audit Complete! Check your reports.

        - id: Condition_Failed
          condition: =Topic.status = "failed"
          actions:
            - kind: SendActivity
              id: SendActivity_Fail
              activity: "Audit Failed: {Topic.message}"

      elseActions:
        - kind: AdaptiveCardPrompt
          id: Prompt_StatusCard
          card: |-
            {
              "type": "AdaptiveCard",
              "version": "1.5",
              "body": [
                {
                  "type": "TextBlock",
                  "text": "Status: {Topic.status}",
                  "weight": "Bolder",
                  "size": "Medium"
                },
                {
                  "type": "TextBlock",
                  "text": "Logs: {Topic.logs_text}",
                  "wrap": true,
                  "size": "Small",
                  "maxLines": 5
                }
              ],
              "actions": [
                {
                  "type": "Action.Submit",
                  "title": "ðŸ”„ Refresh Status",
                  "data": {
                    "submitActionId": "refresh"
                  }
                }
              ]
            }
          output:
            binding:
              submitActionId: Topic.CardAction

          outputType:
            properties:
              submitActionId: String

        - kind: GotoAction
          id: Loop_Back
          actionId: Action_GetStatus

inputType: {}
outputType: {}