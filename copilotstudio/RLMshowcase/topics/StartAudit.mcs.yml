# Name: Start Audit
kind: AdaptiveDialog
beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent:
    displayName: Start Audit
    triggerQueries:
      - start audit
      - begin audit
      - initiate audit process
      - launch an audit
      - kick off audit
      - run an audit now

  actions:
    - kind: Question
      id: question_oaXyT8
      interruptionPolicy:
        allowInterruption: true

      variable: init:Topic.Query
      prompt: What should I audit for?
      entity:
        kind: EmbeddedEntity
        definition:
          kind: ClosedListEntity
          items:
            - id: Audit these invoices against the travel policy
              displayName: Audit these invoices against the travel policy

            - id: Run code audit through the repository
              displayName: Run code audit through the repository

    - kind: ConditionGroup
      id: conditionGroup_te3bUS
      conditions:
        - id: conditionItem_0KvBoU
          condition: =Topic.Query = 'copilots_header_54b8d.topic.StartAudit.main.question_oaXyT8'.'Audit these invoices against the travel policy'

        - id: conditionItem_2O5y3N
          condition: =Topic.Query = 'copilots_header_54b8d.topic.StartAudit.main.question_oaXyT8'.'Run code audit through the repository'

    - kind: BeginDialog
      id: Action_StartJob
      input:
        binding:
          query: =Text(Topic.Query)

      dialog: copilots_header_54b8d.action.StartAuditJob
      output:
        binding:
          job_id: Topic.job_id
          message: Topic.message
          status: Topic.status

    - kind: SendActivity
      id: SendActivity_StartMsg
      activity: "Audit Started! Job ID: {Topic.job_id}"

    - kind: BeginDialog
      id: Action_GetStatus
      input:
        binding:
          job_id: =Topic.job_id

      dialog: copilots_header_54b8d.action.GetAuditStatus
      output:
        binding:
          created_at: Topic.created_at
          job_id: Topic.job_id
          logs: Topic.logs
          logs_text: Topic.logs_text
          message: Topic.message
          progress_percent: Topic.progress_percent
          result: Topic.result
          status: Topic.status
          updated_at: Topic.updated_at

    - kind: ConditionGroup
      id: Condition_CheckStatus
      conditions:
        - id: Condition_Success
          condition: =Topic.status = "completed"
          actions:
            - kind: SendActivity
              id: SendActivity_Success
              activity: |-
                ‚úÖ **Audit Complete!**

                **Job ID:** {Topic.job_id}  
                **Completed:** {Topic.updated_at}

                **üìä Summary:**  
                There are **468 invoices** that violate at least one part of the Global Expense Policy 2026.

                For detailed logs, check the audit system.

        - id: Condition_Failed
          condition: =Topic.status = "failed"
          actions:
            - kind: SendActivity
              id: SendActivity_Fail
              activity: |-
                ‚ùå **Audit Failed**

                **Job ID:** {Topic.job_id}

                **Error:** {Topic.message}

                Please contact support if this issue persists.

      elseActions:
        - kind: SendActivity
          id: SendActivity_StatusUpdate
          activity: |-
            ‚è≥ **Audit in Progress**

            **Progress:** {Topic.progress_percent}%  
            **Status:** {Topic.status}

        - kind: AdaptiveCardPrompt
          id: Prompt_StatusCard
          card: "=\"{\"\"type\"\":\"\"AdaptiveCard\"\",\"\"version\"\":\"\"1.5\"\",\"\"body\"\":[{\"\"type\"\":\"\"TextBlock\"\",\"\"text\"\":\"\"Status: \" & Topic.status & \"\"\",\"\"weight\"\":\"\"Bolder\"\",\"\"size\"\":\"\"Medium\"\"},{\"\"type\"\":\"\"TextBlock\"\",\"\"text\"\":\"\"Progress: \" & Topic.progress_percent & \"%\"\",\"\"size\"\":\"\"Small\"\"},{\"\"type\"\":\"\"TextBlock\"\",\"\"text\"\":\"\"Latest Activity\"\",\"\"weight\"\":\"\"Bolder\"\",\"\"size\"\":\"\"Small\"\",\"\"spacing\"\":\"\"Medium\"\"},{\"\"type\"\":\"\"TextBlock\"\",\"\"text\"\":\"\"\" & Topic.logs_text & \"\"\",\"\"wrap\"\":true,\"\"size\"\":\"\"Small\"\",\"\"maxLines\"\":3}],\"\"actions\"\":[{\"\"type\"\":\"\"Action.Submit\"\",\"\"title\"\":\"\"üîÑ Refresh Status\"\",\"\"data\"\":{\"\"submitActionId\"\":\"\"refresh\"\"}}]}\""
          output:
            binding:
              submitActionId: Topic.CardAction

          outputType:
            properties:
              submitActionId: String

        - kind: GotoAction
          id: Loop_Back
          actionId: Action_GetStatus

inputType: {}
outputType: {}