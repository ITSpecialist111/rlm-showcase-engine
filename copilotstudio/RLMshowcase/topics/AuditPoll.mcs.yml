# Name: Audit Poll
kind: AdaptiveDialog
beginDialog:
  kind: OnRecognizedIntent
  id: AuditPoll
  intent:
    displayName: AuditPoll
    includeInOnSelectIntent: false
    triggerQueries:
      - audit poll
      - check status
  actions:
    - kind: InvokeConnectorAction
      id: invoke_get_status
      connectionReference: copilots_header_54b8d.shared_rlmfunctions
      connectionProperties:
        mode: Invoker
      operationId: get_audit_status
      parameters:
        job_id: Global.JobId
      outputParameters:
        status: Topic.Status
        progress_percent: Topic.Progress
        logs: Topic.Logs
        result: Topic.Result

    - kind: SendActivity
      id: show_status
      activity:
        text:
          - "Status: {Topic.Status} ({Topic.Progress}%)"

    - kind: ConditionGroup
      id: check_completion
      conditions:
        - id: if_completed
          condition: =Topic.Status = "completed"
          actions:
            - kind: SendActivity
              id: show_result
              activity:
                text:
                  - "✅ **Audit Complete!**"
        
        - id: if_failed
          condition: =Topic.Status = "failed"
          actions:
             - kind: SendActivity
               id: show_error
               activity:
                 text:
                   - "❌ **Audit Failed**."

      elseActions:
        - kind: SendActivity
          id: wait_msg
          activity:
            text: 
              - "Still processing... checking again shortly."
        
        # Simplified loop without DelayAction to avoid schema errors
        - kind: BeginDialog
          id: loop_poll
          dialog: AuditPoll
